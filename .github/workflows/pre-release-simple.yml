name: Version Bump and Tag

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: "Version bump type"
        required: true
        default: "patch"
        type: choice
        options:
          - stable
          - rc
          - patch
          - minor

permissions:
  contents: write

env:
  NODE_VERSION: 22

jobs:
  version-and-tag:
    runs-on: ubuntu-22.04
    outputs:
      new_tag: ${{ steps.version.outputs.new_tag }}
      new_version: ${{ steps.version.outputs.new_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install cargo-edit
        run: |
          if ! command -v cargo-set-version &> /dev/null; then
            cargo install cargo-edit
          fi

      - name: Determine and update versions
        id: version
        run: |
          # USE LOCAL VERSION AS SOURCE OF TRUTH
          current_version=$(node -p "require('./package.json').version")
          echo "Current local version: $current_version"

          # Handle version bump based on input type
          case "${{ github.event.inputs.version_type }}" in
            stable)
              # Stabilize RC: strip -rc.N suffix
              if [[ "$current_version" =~ -rc\.[0-9]+$ ]]; then
                new_version=$(echo "$current_version" | sed 's/-rc\.[0-9]*$//')
                echo "Stabilizing RC: $current_version â†’ $new_version"
              else
                echo "Error: 'stable' type requires RC version, but current is: $current_version"
                exit 1
              fi
              ;;
            rc)
              # Increment RC number: 0.5.1-rc.1 â†’ 0.5.1-rc.2
              if [[ "$current_version" =~ -rc\.([0-9]+)$ ]]; then
                RC_NUM="${BASH_REMATCH[1]}"
                new_version=$(echo "$current_version" | sed "s/-rc\.$RC_NUM$/-rc.$((RC_NUM + 1))/")
                echo "Incrementing RC: $current_version â†’ $new_version"
              else
                echo "Error: 'rc' type requires RC version, but current is: $current_version"
                exit 1
              fi
              ;;
            patch|minor|major)
              # Normal semver bump using CLI
              new_version=$(npx semver -i ${{ github.event.inputs.version_type }} $current_version)
              echo "Version bump: $current_version â†’ $new_version"
              ;;
            *)
              echo "Invalid version type: ${{ github.event.inputs.version_type }}"
              exit 1
              ;;
          esac

          # Update root package.json
          npm version "$new_version" --no-git-tag-version --allow-same-version

          # Update npx-cli package.json
          cd npx-cli
          npm version "$new_version" --no-git-tag-version --allow-same-version --no-workspaces-update
          cd ..

          # Update frontend package.json
          cd frontend
          node -e "const fs = require('fs'); const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8')); pkg.version = '$new_version'; fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\\n');"
          cd ..

          # Update all Cargo.toml files
          cargo set-version --workspace "$new_version"

          # Create tag
          new_tag="v${new_version}"

          echo "new_version=$new_version" >> $GITHUB_OUTPUT
          echo "new_tag=$new_tag" >> $GITHUB_OUTPUT

      - name: Commit changes and create tag
        run: |
          git config --local user.email "genie@namastex.ai"
          git config --local user.name "Automagik Genie"
          
          # Stage package.json files
          git add package.json npx-cli/package.json frontend/package.json
          # Stage lockfiles (these get updated by npm version and cargo set-version)
          if [ -f pnpm-lock.yaml ]; then git add pnpm-lock.yaml; fi
          if [ -f npx-cli/package-lock.json ]; then git add npx-cli/package-lock.json; fi
          if [ -f Cargo.lock ]; then git add Cargo.lock; fi
          # Stage all Cargo.toml files (exclude upstream submodule)
          git add $(find . -name Cargo.toml -not -path './upstream/*')
          
          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "No changes to commit - version already at ${{ steps.version.outputs.new_version }}"
            # Check if tag already exists
            if git rev-parse ${{ steps.version.outputs.new_tag }} >/dev/null 2>&1; then
              echo "Tag ${{ steps.version.outputs.new_tag }} already exists - skipping"
            else
              echo "Creating new tag ${{ steps.version.outputs.new_tag }}"
              git tag -a ${{ steps.version.outputs.new_tag }} -m "Release ${{ steps.version.outputs.new_tag }}"
              git push --tags
            fi
          else
            git commit -m "chore: bump version to ${{ steps.version.outputs.new_version }}"
            git tag -a ${{ steps.version.outputs.new_tag }} -m "Release ${{ steps.version.outputs.new_tag }}"
            git push
            git push --tags
          fi

      - name: Determine release type
        id: release_type
        run: |
          # Check if this is an RC version
          if [[ "${{ steps.version.outputs.new_version }}" =~ -rc\. ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "release_name=Pre-release ${{ steps.version.outputs.new_tag }}" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "release_name=Release ${{ steps.version.outputs.new_tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.new_tag }}
          name: ${{ steps.release_type.outputs.release_name }}
          prerelease: ${{ steps.release_type.outputs.is_prerelease }}
          make_latest: ${{ steps.release_type.outputs.is_prerelease == 'false' }}
          generate_release_notes: true
          body: |
            ðŸš€ **Release v${{ steps.version.outputs.new_version }}**

            Build in progress. Artifacts will be uploaded once the build completes.
