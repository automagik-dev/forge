name: Version Bump and Tag

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: "Version bump type"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

env:
  NODE_VERSION: 22

jobs:
  version-and-tag:
    runs-on: ubuntu-22.04
    outputs:
      new_tag: ${{ steps.version.outputs.new_tag }}
      new_version: ${{ steps.version.outputs.new_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install cargo-edit
        run: |
          if ! command -v cargo-set-version &> /dev/null; then
            cargo install cargo-edit
          fi

      - name: Determine and update versions
        id: version
        run: |
          # USE LOCAL VERSION AS SOURCE OF TRUTH
          current_version=$(node -p "require('./package.json').version")
          echo "Current local version: $current_version"

          # Check if this is an RC version
          if [[ "$current_version" =~ -rc\. ]]; then
            # RC version - just strip suffix to get stable version
            new_version=$(echo "$current_version" | sed 's/-rc\.[0-9]*$//')
            echo "Stabilizing RC: $current_version â†’ $new_version"
          else
            # Not RC - bump version based on type
            case "${{ github.event.inputs.version_type }}" in
              patch)
                new_version=$(node -p "const semver = require('semver'); semver.inc('$current_version', 'patch')")
                ;;
              minor)
                new_version=$(node -p "const semver = require('semver'); semver.inc('$current_version', 'minor')")
                ;;
              major)
                new_version=$(node -p "const semver = require('semver'); semver.inc('$current_version', 'major')")
                ;;
              *)
                echo "Invalid version type: ${{ github.event.inputs.version_type }}"
                exit 1
                ;;
            esac
            echo "Version bump: $current_version â†’ $new_version"
          fi

          # Update root package.json
          npm version "$new_version" --no-git-tag-version --allow-same-version

          # Update npx-cli package.json
          cd npx-cli
          npm version "$new_version" --no-git-tag-version --allow-same-version --no-workspaces-update
          cd ..

          # Update frontend package.json
          cd frontend
          node -e "const fs = require('fs'); const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8')); pkg.version = '$new_version'; fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\\n');"
          cd ..

          # Update all Cargo.toml files
          cargo set-version --workspace "$new_version"

          # Create tag
          new_tag="v${new_version}"

          echo "new_version=$new_version" >> $GITHUB_OUTPUT
          echo "new_tag=$new_tag" >> $GITHUB_OUTPUT

      - name: Commit changes and create tag
        run: |
          git config --local user.email "genie@namastex.ai"
          git config --local user.name "Automagik Genie"
          
          # Stage package.json files
          git add package.json npx-cli/package.json frontend/package.json
          # Stage pnpm lockfile if it exists
          if [ -f pnpm-lock.yaml ]; then git add pnpm-lock.yaml; fi
          # Stage all Cargo.toml files (exclude upstream submodule)
          git add $(find . -name Cargo.toml -not -path './upstream/*')
          
          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "No changes to commit - version already at ${{ steps.version.outputs.new_version }}"
            # Check if tag already exists
            if git rev-parse ${{ steps.version.outputs.new_tag }} >/dev/null 2>&1; then
              echo "Tag ${{ steps.version.outputs.new_tag }} already exists - skipping"
            else
              echo "Creating new tag ${{ steps.version.outputs.new_tag }}"
              git tag -a ${{ steps.version.outputs.new_tag }} -m "Release ${{ steps.version.outputs.new_tag }}"
              git push --tags
            fi
          else
            git commit -m "chore: bump version to ${{ steps.version.outputs.new_version }}"
            git tag -a ${{ steps.version.outputs.new_tag }} -m "Release ${{ steps.version.outputs.new_tag }}"
            git push
            git push --tags
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.new_tag }}
          name: Release ${{ steps.version.outputs.new_tag }}
          prerelease: false
          make_latest: true
          generate_release_notes: true
          body: |
            ðŸš€ **Release v${{ steps.version.outputs.new_version }}**

            Build in progress. Artifacts will be uploaded once the build completes.