name: ðŸš€ Unified Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:
    inputs:
      action:
        description: 'Release action'
        required: true
        type: choice
        options:
          - 'bump-rc'
          - 'promote-to-stable'
          - 'manual-tag'
        default: 'bump-rc'
      tag:
        description: 'Version tag for manual-tag (e.g., v0.4.6)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  packages: write

env:
  NODE_VERSION: 22
  RUST_TOOLCHAIN: nightly-2025-05-18

jobs:
  release:
    runs-on: ubuntu-22.04
    outputs:
      version: ${{ steps.release.outputs.version }}
      released: ${{ steps.release.outputs.released }}

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive

      - name: ðŸ”§ Setup Node
        uses: ./.github/actions/setup-node

      - name: âš™ï¸ Configure Git
        run: |
          git config --global user.email "genie@namastex.ai"
          git config --global user.name "Automagik Genie"

      - name: ðŸ” Determine Release Type
        id: detect
        run: |
          EVENT="${{ github.event_name }}"
          REF="${{ github.ref }}"

          # Determine action based on trigger
          if [ "$EVENT" = "workflow_dispatch" ]; then
            ACTION="${{ github.event.inputs.action }}"
          elif [ "$EVENT" = "push" ] && [[ "$REF" == refs/tags/* ]]; then
            ACTION="tag-push"
          elif [ "$EVENT" = "push" ] && [ "$REF" = "refs/heads/main" ]; then
            # Check if commit contains code changes
            COMMIT_MSG=$(git log -1 --pretty=%B)

            # Skip automated pre-release commits (prevents infinite loop)
            if echo "$COMMIT_MSG" | grep -Eq "^chore: pre-release|^chore:.*bump"; then
              echo "Skipping automated pre-release commit"
              ACTION="skip"
            # Trigger RC for code-changing commits
            elif echo "$COMMIT_MSG" | grep -Eq "^(feat|fix|test|build):"; then
              echo "Code-changing commit detected: triggering RC bump"
              ACTION="auto-bump-rc"
            # Skip documentation and non-code commits
            elif echo "$COMMIT_MSG" | grep -Eq "^(docs|chore|style|refactor|perf|ci):"; then
              echo "Non-code commit detected: skipping release"
              ACTION="skip"
            # Default: trigger RC for PR merges
            else
              echo "Non-conventional commit: triggering RC bump"
              ACTION="auto-bump-rc"
            fi
          elif [ "$EVENT" = "pull_request" ]; then
            # Merge dev â†’ main or release PR â†’ main
            HEAD="${{ github.event.pull_request.head.ref }}"
            MERGED="${{ github.event.pull_request.merged }}"
            if [ "$MERGED" = "true" ]; then
              ACTION="merge-rc"
            else
              ACTION="skip"
            fi
          else
            ACTION="skip"
          fi

          echo "action=$ACTION" >> $GITHUB_OUTPUT
          echo "Release action: $ACTION"

      - name: â­ï¸ Skip if Not Needed
        if: steps.detect.outputs.action == 'skip'
        run: echo "No release needed for this event"

      - name: ðŸ“Œ Bump RC (Auto)
        if: steps.detect.outputs.action == 'auto-bump-rc'
        id: release
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node scripts/unified-release.cjs \
            --bump rc \
            --publish \
            --github-release \
            --skip-build
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "released=true" >> $GITHUB_OUTPUT

      - name: ðŸ“Œ Bump RC (Merge to main)
        if: steps.detect.outputs.action == 'merge-rc'
        id: merge_rc
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Clean conflicting RC tags
          CURRENT=$(node -p "require('./package.json').version")
          if [[ $CURRENT =~ ^([0-9]+\.[0-9]+\.[0-9]+)-rc\.([0-9]+)$ ]]; then
            BASE="${BASH_REMATCH[1]}"
            RC_NUM="${BASH_REMATCH[2]}"
            NEXT_RC=$((RC_NUM + 1))
            NEXT_TAG="v${BASE}-rc.${NEXT_RC}"
            git tag -d "$NEXT_TAG" 2>/dev/null || true
            git push origin ":refs/tags/$NEXT_TAG" 2>/dev/null || true
          fi

          node scripts/unified-release.cjs \
            --bump rc \
            --publish \
            --github-release \
            --skip-build

          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "released=true" >> $GITHUB_OUTPUT

      - name: ðŸ“Œ Tag Push (Publish Existing)
        if: steps.detect.outputs.action == 'tag-push'
        id: tag_push
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.ref }}"
          VERSION=${TAG#refs/tags/v}

          node scripts/unified-release.cjs \
            --tag "v$VERSION" \
            --publish \
            --github-release \
            --skip-tests \
            --skip-build

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "released=true" >> $GITHUB_OUTPUT

      - name: ðŸŽ¯ Manual Dispatch
        if: steps.detect.outputs.action == 'bump-rc' || steps.detect.outputs.action == 'promote-to-stable' || steps.detect.outputs.action == 'manual-tag'
        id: manual
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ACTION="${{ github.event.inputs.action }}"

          if [ "$ACTION" = "bump-rc" ]; then
            node scripts/unified-release.cjs --bump rc --publish --github-release --skip-build
          elif [ "$ACTION" = "promote-to-stable" ]; then
            node scripts/unified-release.cjs --promote --publish --github-release
          elif [ "$ACTION" = "manual-tag" ]; then
            TAG="${{ github.event.inputs.tag }}"
            node scripts/unified-release.cjs --tag "$TAG" --publish --github-release --skip-tests --skip-build
          fi

          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "released=true" >> $GITHUB_OUTPUT

      - name: âœ… Release Summary
        if: success() && (steps.release.outputs.released == 'true' || steps.merge_rc.outputs.released == 'true' || steps.tag_push.outputs.released == 'true' || steps.manual.outputs.released == 'true')
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "ðŸŽ‰ Released v$VERSION"
          echo "ðŸ“¦ npm install automagik-forge@$(echo $VERSION | grep -q 'rc' && echo 'next' || echo 'latest')"
          echo "ðŸ”— https://github.com/${{ github.repository }}/releases/tag/v$VERSION"

      - name: ðŸ”¨ Trigger Binary Builds (RC only)
        if: success() && (steps.release.outputs.released == 'true' || steps.merge_rc.outputs.released == 'true') && contains(steps.release.outputs.version || steps.merge_rc.outputs.version, '-rc.')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "Triggering binary builds for v$VERSION"
          gh workflow run build-all-platforms.yml --ref "v$VERSION"
