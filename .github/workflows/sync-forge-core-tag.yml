name: Sync forge-core Version

# Automatically updates forge-core workspace dependencies when forge-core publishes to crates.io
# Triggered by repository_dispatch from forge-core publish-crates.yml workflow

on:
  repository_dispatch:
    types: [forge-core-tag-created, forge-core-published]

  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      version:
        description: 'forge-core version to sync (e.g., 0.8.7-rc.38)'
        required: true
        type: string

jobs:
  sync-tag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Support both 'version' (new) and 'tag' (legacy) payloads
            VERSION="${{ github.event.client_payload.version }}"
            if [ -z "$VERSION" ]; then
              TAG="${{ github.event.client_payload.tag }}"
              VERSION="${TAG#v}"  # Strip 'v' prefix if present
            fi
          fi

          # Validate version format (e.g., 0.8.7 or 0.8.7-rc.38)
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-rc.N"
            exit 1
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "âœ… Syncing forge-core version: ${VERSION}"

      - name: Update forge-core version references
        run: |
          NEW_VERSION="${{ steps.version.outputs.version }}"

          echo "ðŸ“ Updating workspace Cargo.toml with version ${NEW_VERSION}..."

          # Update workspace dependencies in root Cargo.toml (crates.io versions)
          # Pattern: forge-core-XXX = "X.Y.Z" or "X.Y.Z-rc.N"
          sed -i "s/^forge-core-utils = \"[^\"]*\"/forge-core-utils = \"$NEW_VERSION\"/g" Cargo.toml
          sed -i "s/^forge-core-executors = \"[^\"]*\"/forge-core-executors = \"$NEW_VERSION\"/g" Cargo.toml
          sed -i "s/^forge-core-db = \"[^\"]*\"/forge-core-db = \"$NEW_VERSION\"/g" Cargo.toml
          sed -i "s/^forge-core-services = \"[^\"]*\"/forge-core-services = \"$NEW_VERSION\"/g" Cargo.toml
          sed -i "s/^forge-core-deployment = \"[^\"]*\"/forge-core-deployment = \"$NEW_VERSION\"/g" Cargo.toml
          sed -i "s/^forge-core-local-deployment = \"[^\"]*\"/forge-core-local-deployment = \"$NEW_VERSION\"/g" Cargo.toml
          sed -i "s/^forge-core-server = \"[^\"]*\"/forge-core-server = \"$NEW_VERSION\"/g" Cargo.toml

          echo "âœ… Updated workspace dependencies in Cargo.toml"

          echo ""
          echo "ðŸ“‹ Changes made:"
          git diff --stat
          echo ""
          git diff Cargo.toml

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create branch for Cargo.toml update
        run: |
          NEW_VERSION="${{ steps.version.outputs.version }}"
          BRANCH_NAME="chore/update-forge-core-v${NEW_VERSION}"

          # Check if there are changes
          if git diff --quiet; then
            echo "âš ï¸ No changes detected - forge-core version may already be up to date"
            exit 0
          fi

          git checkout -b "${BRANCH_NAME}"
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT

      - name: Update Cargo.lock
        run: |
          # Install Rust toolchain
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env

          # Update forge-core dependencies in Cargo.lock
          cargo update -p forge-core-utils -p forge-core-executors -p forge-core-db -p forge-core-services -p forge-core-deployment -p forge-core-local-deployment -p forge-core-server || echo "âš ï¸ Some forge-core packages may not exist yet"

      - name: Commit changes
        id: commit
        run: |
          NEW_VERSION="${{ steps.version.outputs.version }}"

          git add Cargo.toml Cargo.lock
          git commit -m "chore: update forge-core to v${NEW_VERSION}"
          git push origin HEAD

          echo "âœ… Pushed forge-core update to branch"

      - name: Create PR with labels
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          NEW_VERSION="${{ steps.version.outputs.version }}"

          gh pr create \
            --title "chore: update forge-core to v${NEW_VERSION}" \
            --body "Auto-update forge-core workspace dependencies after successful crates.io publish.

          **Forge-core version**: ${NEW_VERSION}
          **Triggered by**: forge-core publish-crates.yml workflow

          This PR will be auto-merged after checks pass.

          ### Changes
          - Updated all 7 forge-core workspace dependencies to \`${NEW_VERSION}\`
          - Regenerated Cargo.lock" \
            --base dev \
            --head chore/update-forge-core-v${NEW_VERSION} \
            --label "rc" \
            --label "dependencies"

          echo "âœ… Created PR with 'rc' and 'dependencies' labels"

      - name: Create summary
        run: |
          echo "## ðŸ”„ forge-core Sync PR Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **New Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: chore/update-forge-core-v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Base**: dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Labels**: rc, dependencies" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Updated" >> $GITHUB_STEP_SUMMARY
          echo "- Cargo.toml (7 workspace dependencies)" >> $GITHUB_STEP_SUMMARY
          echo "- Cargo.lock" >> $GITHUB_STEP_SUMMARY
