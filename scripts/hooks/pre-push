#!/bin/bash
# Pre-push hook for automagik-forge
# BLOCKS push if dev-core mode is active (Cargo [patch] uncommented)
# Installed by: make dev-core
# To bypass: git push --no-verify (not recommended)

set -e

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m'

DEV_CORE_ACTIVE=false

# Check .cargo/config.toml for ACTIVE forge-core [patch] section ONLY
# We only block on forge-core patches, not crates-io patches (codex fork)
# Pattern: line starts with [patch."https://github.com/namastexlabs/forge-core
if [ -f ".cargo/config.toml" ]; then
    if grep -q '^\[patch\."https://github.com/namastexlabs/forge-core' .cargo/config.toml 2>/dev/null; then
        DEV_CORE_ACTIVE=true
    fi
fi

if [ "$DEV_CORE_ACTIVE" = "true" ]; then
    echo ""
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘  ğŸ›‘ PUSH BLOCKED: dev-core mode is ACTIVE                   â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "Your workspace is configured to use local forge-core paths."
    echo -e "Pushing this will break CI/CD and anyone who pulls your branch."
    echo ""
    echo -e "${CYAN}To fix this:${NC}"
    echo -e "  1. ${GREEN}make dev-core-off${NC}    # Restore git dependencies"
    echo -e "  2. ${GREEN}make build${NC}          # Verify it compiles"
    echo -e "  3. ${GREEN}git push${NC}            # Try again"
    echo ""
    echo -e "${YELLOW}Detection:${NC}"
    echo "  .cargo/config.toml has active [patch] section"
    echo ""
    echo -e "${YELLOW}If you really need to push with dev-core on:${NC}"
    echo -e "  git push --no-verify (not recommended)"
    echo ""
    exit 1
fi

echo -e "${GREEN}âœ… Pre-push check passed (dev-core mode is OFF)${NC}"
exit 0
