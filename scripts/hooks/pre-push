#!/bin/bash
# Pre-push hook for automagik-forge
# FULLY AUTOMATIC dual-repo push:
# 1. Push forge-core first (if exists with unpushed commits)
# 2. Auto-disable patches (if active)
# 3. Amend commit with Cargo.lock changes
# 4. Allow forge push
#
# Installed by: make dev-core
# To bypass: git push --no-verify (not recommended)

set -e

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m'

FORGE_CORE_DIR="forge-core"
CONFIG_FILE=".cargo/config.toml"

# === Step 1: Push forge-core first if it has unpushed commits ===
if [ -d "$FORGE_CORE_DIR/.git" ]; then
    ORIG_DIR=$(pwd)
    cd "$FORGE_CORE_DIR"
    BRANCH=$(git branch --show-current)

    # Check if remote tracking branch exists
    if git rev-parse --verify "origin/$BRANCH" >/dev/null 2>&1; then
        # Compare with remote
        UNPUSHED=$(git log "origin/$BRANCH..HEAD" --oneline 2>/dev/null | wc -l)
    else
        # No remote tracking - all commits are "unpushed"
        UNPUSHED=$(git log --oneline 2>/dev/null | wc -l)
    fi

    if [ "$UNPUSHED" -gt 0 ]; then
        echo ""
        echo -e "${CYAN}üì§ Pushing forge-core first ($UNPUSHED commit(s) ahead)...${NC}"
        if git push --no-verify -u origin "$BRANCH" 2>&1; then
            echo -e "${GREEN}‚úÖ forge-core pushed${NC}"
        else
            echo -e "${RED}‚ùå Failed to push forge-core${NC}"
            cd "$ORIG_DIR"
            exit 1
        fi
    fi
    cd "$ORIG_DIR"
fi

# === Step 2: Auto-disable patches if active ===
# Check for active (uncommented) [patch.crates-io] section with forge-core paths
if grep -q '^forge-core-.*= { path' "$CONFIG_FILE" 2>/dev/null; then
    echo ""
    echo -e "${CYAN}üîÑ Auto-disabling Cargo patches...${NC}"

    # Comment out the [patch.crates-io] section header
    sed -i 's/^\[patch\.crates-io\]/# [patch.crates-io]/g' "$CONFIG_FILE"

    # Comment out all forge-core path entries
    sed -i 's/^forge-core-\(.*\) = { path/# forge-core-\1 = { path/g' "$CONFIG_FILE"

    echo -e "${CYAN}   Regenerating Cargo.lock...${NC}"

    # Regenerate Cargo.lock with git dependencies
    rm -f Cargo.lock
    CARGO_OUTPUT=$(mktemp)
    if ! cargo fetch 2>"$CARGO_OUTPUT"; then
        echo -e "${RED}ERROR: cargo fetch failed to regenerate Cargo.lock${NC}"
        cat "$CARGO_OUTPUT"
        rm -f "$CARGO_OUTPUT"
        exit 1
    fi
    rm -f "$CARGO_OUTPUT"

    # Stage the config and lock file changes
    if ! git add "$CONFIG_FILE"; then
        echo -e "${RED}ERROR: Failed to stage $CONFIG_FILE${NC}"
        exit 1
    fi
    if [ -f "Cargo.lock" ]; then
        if ! git add Cargo.lock; then
            echo -e "${RED}ERROR: Failed to stage Cargo.lock${NC}"
            exit 1
        fi
    fi

    # Amend the current commit with these changes
    echo -e "${CYAN}   Amending commit with config changes...${NC}"
    if ! git commit --amend --no-edit --no-verify; then
        echo -e "${RED}ERROR: Failed to amend commit with config changes${NC}"
        echo "Manual fix required:"
        echo "  git add .cargo/config.toml Cargo.lock"
        echo "  git commit --amend --no-edit"
        exit 1
    fi

    echo -e "${GREEN}‚úÖ Patches disabled and commit amended${NC}"
fi

# === Step 3: Final check - patches should be disabled now ===
if grep -q '^forge-core-.*= { path' "$CONFIG_FILE" 2>/dev/null; then
    echo ""
    echo -e "${RED}‚ùå ERROR: Patches are still active after auto-disable attempt${NC}"
    echo -e "   This is a bug - please report it. Manual fix: edit .cargo/config.toml"
    exit 1
fi

echo ""
echo -e "${GREEN}‚úÖ Pre-push checks passed${NC}"
exit 0
