#!/bin/bash
# Pre-commit hook for automagik-forge
# AUTO-SYNCS forge-core changes when dev-core mode is active
# Installed by: make dev-core
#
# This hook:
# 1. Runs CI checks (fmt, clippy, test) on forge-core changes
# 2. Stages any forge-core changes for sync
# The actual commit happens in prepare-commit-msg hook.

set -e

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m'

FORGE_CORE_DIR="forge-core"
SYNC_MARKER=".forge-core-needs-sync"

# Only run if dev-core is active (forge-core subdir exists with .git)
if [ ! -d "$FORGE_CORE_DIR/.git" ]; then
    exit 0
fi

# Check if forge-core has any changes (staged, unstaged, or untracked)
cd "$FORGE_CORE_DIR"

HAS_CHANGES=$(git status --porcelain 2>/dev/null)

if [ -n "$HAS_CHANGES" ]; then
    echo -e "${CYAN}üîç Running CI checks on forge-core...${NC}"

    # Run cargo fmt check
    echo -e "   ${CYAN}cargo fmt --all -- --check${NC}"
    if ! cargo fmt --all -- --check; then
        echo -e "${RED}‚ùå Formatting check failed. Run 'cargo fmt --all' to fix.${NC}"
        exit 1
    fi
    echo -e "   ${GREEN}‚úì Format OK${NC}"

    # Run cargo clippy
    echo -e "   ${CYAN}cargo clippy --all --all-targets -- -D warnings${NC}"
    if ! cargo clippy --all --all-targets -- -D warnings 2>&1; then
        echo -e "${RED}‚ùå Clippy check failed. Fix the warnings above.${NC}"
        exit 1
    fi
    echo -e "   ${GREEN}‚úì Clippy OK${NC}"

    # Run cargo test
    echo -e "   ${CYAN}cargo test --workspace${NC}"
    if ! cargo test --workspace 2>&1; then
        echo -e "${RED}‚ùå Tests failed. Fix the failing tests above.${NC}"
        exit 1
    fi
    echo -e "   ${GREEN}‚úì Tests OK${NC}"

    echo -e "${GREEN}‚úÖ All CI checks passed${NC}"

    # Stage all forge-core changes
    git add -A
fi

cd ..

if [ -n "$HAS_CHANGES" ]; then
    # Mark that we need to sync (commit happens in prepare-commit-msg)
    touch "$SYNC_MARKER"

    echo -e "${CYAN}üì¶ forge-core changes staged for sync${NC}"
    echo -e "   Changes will be committed with the same message"
fi

exit 0
