#!/bin/bash
# Prepare-commit-msg hook for automagik-forge
# SYNCS forge-core with the same commit message when dev-core is active
# Installed by: make dev-core
#
# This hook commits staged forge-core changes using the same message
# as the automagik-forge commit.

COMMIT_MSG_FILE="$1"
COMMIT_SOURCE="$2"  # message, template, merge, squash, or commit
FORGE_CORE_DIR="forge-core"
SYNC_MARKER=".forge-core-needs-sync"

GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m'

# Only sync if marker exists and forge-core is active
if [ ! -f "$SYNC_MARKER" ] || [ ! -d "$FORGE_CORE_DIR/.git" ]; then
    exit 0
fi

# Get the commit message
MSG=$(cat "$COMMIT_MSG_FILE")

# Skip if message is empty or just comments
if [ -z "$(echo "$MSG" | grep -v '^#' | grep -v '^$')" ]; then
    rm -f "$SYNC_MARKER"
    exit 0
fi

# Commit in forge-core with the same message
cd "$FORGE_CORE_DIR"

# Check if there are staged changes
if git diff --cached --quiet 2>/dev/null; then
    # No staged changes, cleanup and exit
    cd ..
    rm -f "$SYNC_MARKER"
    exit 0
fi

# Commit with the same message
if git commit -m "$MSG" 2>/dev/null; then
    SHORT_SHA=$(git rev-parse --short HEAD)
    cd ..
    rm -f "$SYNC_MARKER"
    echo -e "${GREEN}✅ forge-core synced: ${SHORT_SHA}${NC}"
else
    cd ..
    rm -f "$SYNC_MARKER"
    echo -e "${CYAN}ℹ️  forge-core: nothing to commit${NC}"
fi

exit 0
